#cloud-config
#/usr/local/cloud-config/00_wireguard.yaml
stages:
  boot.before:
    - files:
        - path: /etc/wireguard/wg0.conf
          content: |
            [Interface]

            # The IP address of this host in the wireguard tunnels
            Address = 10.222.0.1

            # Every Raspberry Pi connects via UDP to this port. Your Cloud VM must be reachable on this port via UDP from the internet.
            ListenPort = 51871

            # Set the private key to the value of the privatekey file generated by the previous command
            PrivateKey = 4K9POfOinY3qbZ29pgmPhEOZJyfUUfjXMPNXCR8zrmo=

            # Set the MTU according to the internet connections of your clients
            # In our case the autodetection assumed 8920 since the cloud network supported jumbo frames.
            MTU = 1420

            [Peer]
            PublicKey = 1AP+htaDn3kX0JNNctD/qouuPLsVulzbZvDWy5Cw4wY=
            AllowedIPs = 10.222.0.5/32
          permissions: 0644
  network:
    - name: "Run Wireguard"
      commands:
        - rc-service wg-quick.wg0 start
