name: Build
on:
  workflow_dispatch:
permissions:
  id-token: write  # OIDC support
  contents: write
  actions: read
  security-events: write
  models: none
    
jobs:
  build-amd64:
    uses: ./.github/workflows/factory.yaml
    with:
      version: "auto"
      base_image: "alpine:3.22"
      model: "generic"
      iso: true
      summary_artifacts: true
      arch: amd64
      kubernetes_version: "v1.34.1+k3s1"
      kubernetes_distro: k3s
      dockerfile_path: Dockerfile
      custom_artifact_format: "kairos-amd64"
  build-rpi:
    uses: ./.github/workflows/factory.yaml
    with:
      version: "auto"
      base_image: "alpine:3.22"
      model: "rpi4"
      raw: true
      summary_artifacts: true
      arch: arm64
      kubernetes_version: "v1.34.1+k3s1"
      kubernetes_distro: k3s
      dockerfile_path: Dockerfile
      custom_artifact_format: "kairos-rpi"
  release:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    needs: ["build-amd64", "build-rpi"]
    steps:
      - run: mkdir /tmp/artifacts
      - uses: actions/download-artifact@v5
        with:
          pattern: "*.zip"
          path: /tmp/artifacts
      - run: |
          for zipfile in /tmp/artifacts*.zip; do
              if [ -f "$zipfile" ]; then
                  unzip -o "$zipfile" -d /tmp
              fi
          done
      - uses: actions/checkout@v4
        with:
          fetch-depth: '0'
      - uses: anothrNick/github-tag-action@4ed44965e0db8dab2b466a16da04aec3cc312fd8
        id: tag
      - uses: ncipollo/release-action@v1.20.0
        with:
          artifacts: "/tmp/artifacts/*.iso,/tmp/artifacts/*.raw"
          tag: ${{ steps.tag.outputs.tag }}
          skipIfReleaseExists: true

